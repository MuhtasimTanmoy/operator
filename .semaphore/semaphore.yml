version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
global_job_config:
  secrets:
  - name: docker-hub
  prologue:
    commands:
    - echo $DOCKERHUB_PASSWORD | docker login --username "$DOCKERHUB_USERNAME" --password-stdin

blocks:
  - name: Build
    task:
      jobs:
        - name: Build
          commands:
            - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
            - make ci
            - >-
              if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then 
                make cd CONFIRM=true;
              fi
            - >-
              if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then
                make maybe-build-release;
              fi
      secrets:
        - name: docker
        - name: google-service-account-for-gcr
      prologue:
        commands:
          - checkout
          - >-
            if [[ -v SEMAPHORE_GIT_PR_NUMBER ]]; then
              unset DOCKER_USER DOCKER_TOKEN; docker logout; docker logout gcr.io;
            else
              gcloud auth activate-service-account --key-file=/home/semaphore/secrets/secret.google-service-account-key.json
              # Login to docker in order to pull images.
              docker login --username casey@tigera.io -u _json_key -p "$(cat ~/secrets/secret.google-service-account-key.json)" https://gcr.io
            fi
          - cache restore go-pkg-cache
          - cache restore go-mod-cache
      epilogue:
        on_pass:
          commands:
            - cache store go-pkg-cache .go-pkg-cache
            - 'cache store go-mod-cache ${HOME}/go/pkg/mod/cache'
